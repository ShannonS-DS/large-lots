{% extends "base.html" %}
{% load staticfiles %}
{% block extra_css %}
<link href="{% static 'css/jquery.dataTables.min.css' %}" rel="stylesheet">
{% endblock %}
{% block title %}Application list{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-12">
        <ul class="nav nav-pills">
            {% for k,v in pilot_info.items %}
                <li {% if k == selected_pilot %}class='active'{% endif %}>
                    <a href="{% url 'pilot_admin' k %}">{{v.human_name}}</a>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>
<h3>
    {% if applications %}
        {{ applications|length }}
    {% else %}
        0
    {% endif %}
    Applications received
    <small>
        <!-- <a href="/lots-admin-map/"><i class='fa fa-map-marker'></i> Map view</a> &nbsp;&nbsp;&nbsp;  -->
        <a href="{% url 'csv_dump' selected_pilot %}"><i class='fa fa-file-excel-o'></i> Export as CSV</a></small>
</h3>
<h3>
    {% if applications_before_four %}
        {{ applications_before_four|length }} Applications to review before "Multiple applicant check"
    {% else %}
        {{ applications_at_four|length }} Applications on "Multiple applicant check" to complete
    {% endif %}
</h3>
<!-- Form for bulk submit. -->
<form role="form" method="POST" action="{% url 'alderman_advance_submit' %}">
<table id="received" class="table table-striped tablesorter">
    <thead>
        <th>ID</th>
        <th>Date received</th>
        <th>Name/Organization</th>
        <th>Details</th>
        <th class="no-wrap">Next review step</th>
        <th>Bulk review</th>
    </thead>
    <tbody>
    {% for application in applications %}
        <tr>
            <td>
                {{application.id}}
            </td>
            <td>{{application.received_date|date:'Y-m-d g:i a'}}</td>
            <td>
                {{application.first_name}} {{application.last_name}}
                {% if application.organization %}
                <br />
                  {{application.organization}}
                {% endif %}
            </td>
            <td class="no-wrap">
                {% if application.denied %}
                    Status: denied
                {% else %}
                    Status: {{ application.status.public_status }}
                {% endif %}
                </br>
                <a href="/review-status-log/{{ application.id }}">
                    Review history
                </a></br>
                <a href="{% url 'apply_confirm' application.tracking_id %}" target="_blank">Confirmation page</a>
            </td>
            <td>
                {% if application.status %}
                    {% if application.status.step == 2 or application.status.step == 3 %}
                        <a href="/application-review/step-{{ application.status.step }}/{{ application.id }}/" class="btn btn-danger"><i class="fa fa-share" aria-hidden="true"></i> {{ application.status }}</a>
                    {% elif application.status.step == 4 %}
                        {% if applications_before_four %}
                            {{ application.status }}</br>
                            Waiting for other applications
                        {% else %}
                            <a href="/application-review/step-{{ application.status.step }}/{{ application.id }}/" class="btn btn-danger"><i class="fa fa-share" aria-hidden="true"></i> {{ application.status }}</a>
                        {% endif %}
                    {% else %}
                        {{ application.status }}</br>
                        Waiting for decision
                    {% endif %}
                {% else %}
                    None
                {% endif %}
            </td>
            <td>
                <!-- Table cell with form data. -->
                {% if application.status.step == 6 %}
                  {% csrf_token %}
                  <div class="form-group">
                    <div class="checkbox">
                      <label>
                        <input name="advance" value="{{application.id}}" type="checkbox"/>
                      </label>
                    </div>
                  </div>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td>
            Move select applications to next step?</br>
            <button type="submit" class="btn btn-success">Submit</button>
            </td>
        </tr>
    </tbody>
</table>
</form>

{% endblock %}
{% block extra_js %}
    <script src="{% static 'js/jquery-1.12.3.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/jquery.dataTables.min.js' %}" type="text/javascript"></script>
    <script type="text/javascript">
        $(document).ready(function(){
            $('#received').DataTable({
                "order": [[ 1, "desc" ]],
                "paging": false,
                "info": false,
                columnDefs: [
                    {
                        targets: 5,
                        orderable: false
                    },
                ]
            });
        })
    </script>
{% endblock %}
